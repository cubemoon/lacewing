
PREFIX = $(DESTDIR)@prefix@

CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

CXX = @CXX@

SO_EXT = @SO_EXT@
SONAME_FLAGS = @SONAME_FLAGS@

SO_NAME = @SO_NAME@
REAL_NAME = liblacewing.@SO_EXT@.0.5.0

OBJECTS = build/global.o build/nvhash.o build/filter.o build/address.o build/streamgraph.o \
build/stream.o build/error.o build/webserver.o build/http.o build/http-parser.o \
build/mimetypes.o build/request.o build/sessions.o build/pipe.o build/multipart.o \
build/addr_flat.o build/eventpump_flat.o build/server_flat.o build/timer_flat.o \
build/webserver_flat.o build/filter_flat.o build/udp_flat.o build/client_flat.o \
build/error_flat.o build/sync_flat.o build/thread_flat.o build/flashpolicy.o \
build/pump.o build/flashpolicy_flat.o build/file_flat.o build/pump_flat.o build/util.o \
build/multipart_parser.o @OBJECTS@

COMMONDEPS = include/lacewing.h src/common.h src/heapbuffer.h src/list.h \
src/webserver/common.h src/webserver/http/http.h src/address.h \
src/stream.h @COMMONDEPS@

###########

all: liblacewing.@SO_EXT@ liblacewing.a

liblacewing.@SO_EXT@: $(OBJECTS)
	@echo Linking shared library...
	@$(CXX) $(CXXFLAGS) $(SONAME_FLAGS) -shared -o $(REAL_NAME) ./build/*.o $(LIBS)

liblacewing.a: $(OBJECTS)
	@echo Linking static library...
	@ar rcs liblacewing.a ./build/*.o

build/global.o: src/global.c $(COMMONDEPS) 
	$(CC) $(CFLAGS) -c -o $@ src/global.c
build/nvhash.o: src/nvhash.c $(COMMONDEPS) 
	$(CC) $(CFLAGS) -c -o $@ src/nvhash.c
build/util.o: src/util.c $(COMMONDEPS) 
	$(CC) $(CFLAGS) -c -o $@ src/util.c
build/filter.o: src/filter.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/filter.cc
build/address.o: src/address.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/address.cc
build/stream.o: src/stream.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/stream.c
build/streamgraph.o: src/streamgraph.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/streamgraph.c
build/pipe.o: src/pipe.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/pipe.c
build/pump.o: src/pump.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/pump.cc
build/error.o: src/error.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/error.cc
build/webserver.o: src/webserver/webserver.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/webserver.cc
build/request.o: src/webserver/request.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/request.cc
build/sessions.o: src/webserver/sessions.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/sessions.cc
build/mimetypes.o: src/webserver/mimetypes.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/mimetypes.cc
build/multipart.o: src/webserver/multipart.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/multipart.cc
build/http.o: src/webserver/http/http.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/http/http.cc
build/spdy.o: src/webserver/spdy/spdy.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/webserver/spdy/spdy.cc
build/http-parser.o: deps/http-parser/http_parser.c deps/http-parser/http_parser.h
	$(CC) $(CFLAGS) -c -o $@ deps/http-parser/http_parser.c
build/multipart_parser.o: deps/multipart-parser/multipart_parser.c deps/multipart-parser/multipart_parser.h
	$(CC) $(CFLAGS) -c -o $@ deps/multipart-parser/multipart_parser.c
build/flashpolicy.o: src/flashpolicy.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/flashpolicy.cc

build/addr_flat.o: src/wrappers-c/addr_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/addr_flat.cc
build/pump_flat.o: src/wrappers-c/pump_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/pump_flat.cc
build/eventpump_flat.o: src/wrappers-c/eventpump_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/eventpump_flat.cc
build/server_flat.o: src/wrappers-c/server_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/server_flat.cc
build/timer_flat.o: src/wrappers-c/timer_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/timer_flat.cc
build/webserver_flat.o: src/wrappers-c/webserver_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/webserver_flat.cc
build/filter_flat.o: src/wrappers-c/filter_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/filter_flat.cc
build/udp_flat.o: src/wrappers-c/udp_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/udp_flat.cc
build/client_flat.o: src/wrappers-c/client_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/client_flat.cc
build/error_flat.o: src/wrappers-c/error_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/error_flat.cc
build/sync_flat.o: src/wrappers-c/sync_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/sync_flat.cc
build/thread_flat.o: src/wrappers-c/thread_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/thread_flat.cc
build/flashpolicy_flat.o: src/wrappers-c/flashpolicy_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/flashpolicy_flat.cc
build/file_flat.o: src/wrappers-c/file_flat.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/wrappers-c/file_flat.cc

build/openssl-sslclient.o: src/openssl/sslclient.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/openssl/sslclient.cc

build/unix-event.o: src/unix/event.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/event.cc
build/unix-eventpump.o: src/unix/eventpump.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/eventpump.cc
build/unix-server.o: src/unix/server.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/server.cc
build/unix-timer.o: src/unix/timer.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/timer.cc
build/unix-udp.o: src/unix/udp.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/udp.cc
build/unix-thread.o: src/unix/thread.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/thread.cc
build/unix-client.o: src/unix/client.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/client.cc
build/unix-fdstream.o: src/unix/fdstream.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/unix/fdstream.c
build/unix-file.o: src/unix/file.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/unix/file.c
build/unix-sync.o: src/unix/sync.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/unix/sync.cc
build/unix-global.o: src/unix/global.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/unix/global.c

build/windows-event.o: src/windows/event.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/event.cc
build/windows-eventpump.o: src/windows/eventpump.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/eventpump.cc
build/windows-server.o: src/windows/server.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/server.cc
build/windows-timer.o: src/windows/timer.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/timer.cc
build/windows-udp.o: src/windows/udp.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/udp.cc
build/windows-thread.o: src/windows/thread.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/thread.cc
build/windows-client.o: src/windows/client.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/client.cc
build/windows-compat.o: src/windows/compat.c $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/compat.c
build/windows-fdstream.o: src/windows/fdstream.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/fdstream.cc
build/windows-file.o: src/windows/file.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/windows/file.c
build/windows-sync.o: src/windows/sync.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/sync.cc
build/windows-winsslclient.o: src/windows/winsslclient.cc $(COMMONDEPS)
	$(CXX) $(CXXFLAGS) -c -o $@ src/windows/winsslclient.cc
build/windows-global.o: src/windows/global_win.c $(COMMONDEPS)
	$(CC) $(CFLAGS) -c -o $@ src/windows/global_win.c

build/spdy_bytes.o: deps/spdy/src/spdy_bytes.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_bytes.c
build/spdy_control.o: deps/spdy/src/spdy_control.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_control.c
build/spdy_credential.o: deps/spdy/src/spdy_credential.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_credential.c
build/spdy_ctx.o: deps/spdy/src/spdy_ctx.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_ctx.c
build/spdy_goaway.o: deps/spdy/src/spdy_goaway.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_goaway.c
build/spdy_headers.o: deps/spdy/src/spdy_headers.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_headers.c
build/spdy_window_update.o: deps/spdy/src/spdy_window_update.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_window_update.c
build/spdy_nv_block.o: deps/spdy/src/spdy_nv_block.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_nv_block.c
build/spdy_ping.o: deps/spdy/src/spdy_ping.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_ping.c
build/spdy_rst_stream.o: deps/spdy/src/spdy_rst_stream.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_rst_stream.c
build/spdy_settings.o: deps/spdy/src/spdy_settings.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_settings.c
build/spdy_stream.o: deps/spdy/src/spdy_stream.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_stream.c
build/spdy_syn_reply.o: deps/spdy/src/spdy_syn_reply.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_syn_reply.c
build/spdy_syn_stream.o: deps/spdy/src/spdy_syn_stream.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_syn_stream.c
build/spdy_zlib.o: deps/spdy/src/spdy_zlib.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_zlib.c
build/spdy_strings.o: deps/spdy/src/spdy_strings.c
	$(CC) $(CFLAGS) -c -o $@ deps/spdy/src/spdy_strings.c

############
	
clean:
	rm -f liblacewing.@SO_EXT@* liblacewing.a $(OBJECTS)

install: liblacewing.@SO_EXT@ liblacewing.a
	@echo -----
	@echo Installing shared library: $(PREFIX)/lib/liblacewing.@SO_EXT@
	@install -d $(PREFIX)/lib
	@install -m 0755 $(REAL_NAME) $(PREFIX)/lib/$(REAL_NAME)
	@rm -f $(PREFIX)/lib/$(SO_NAME)
	@ln -s $(REAL_NAME) $(PREFIX)/lib/$(SO_NAME)
	@rm -f $(PREFIX)/lib/liblacewing.@SO_EXT@
	@ln -s $(SO_NAME) $(PREFIX)/lib/liblacewing.@SO_EXT@
	@echo Installing static library: $(PREFIX)/lib/liblacewing.a
	@install -m 0755 liblacewing.a $(PREFIX)/lib/liblacewing.a
	@echo Installing header file: $(PREFIX)/include/lacewing.h
	@install -d $(PREFIX)/include
	@install -m 0644 ./include/lacewing.h $(PREFIX)/include/lacewing.h
	@echo -----
	@echo Compiler flags: -I$(PREFIX)/include
	@echo Linker flags: -L$(PREFIX)/lib -llacewing
	@echo ------

.PHONY: all clean install

